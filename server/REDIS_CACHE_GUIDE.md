# Redisç¼“å­˜æ›¿æ¢æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»äº†å¦‚ä½•å°†å†…å­˜ç¼“å­˜æ›¿æ¢ä¸ºRedisç¼“å­˜ç³»ç»Ÿã€‚

## ğŸš€ æ¦‚è¿°

å·²æˆåŠŸå°†TaskManagerä¸­çš„å†…å­˜ç¼“å­˜æ›¿æ¢ä¸ºRedisç¼“å­˜ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šåº”ç”¨é‡å¯åç¼“å­˜æ•°æ®ä¸ä¸¢å¤±
- **åˆ†å¸ƒå¼æ”¯æŒ**ï¼šå¤šä¸ªåº”ç”¨å®ä¾‹å¯ä»¥å…±äº«ç¼“å­˜
- **æ›´å¥½çš„å†…å­˜ç®¡ç†**ï¼šRedisä¸“ä¸šçš„å†…å­˜ç®¡ç†æœºåˆ¶
- **è‡ªåŠ¨è¿‡æœŸ**ï¼šæ”¯æŒTTLè‡ªåŠ¨è¿‡æœŸåŠŸèƒ½
- **å®¹é”™æœºåˆ¶**ï¼šRedisä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°å†…å­˜ç¼“å­˜

## ğŸ›  ç¯å¢ƒé…ç½®

### 1. Rediså®‰è£…

#### Windows (æ¨èä½¿ç”¨WSLæˆ–Docker)
```bash
# ä½¿ç”¨Docker
docker run -d --name redis -p 6379:6379 redis:latest

# æˆ–ä½¿ç”¨Docker Compose
docker-compose up -d redis
```

#### Linux/macOS
```bash
# Ubuntu/Debian
sudo apt-get install redis-server

# CentOS/RHEL
sudo yum install redis

# macOS
brew install redis
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

åœ¨`server/.env`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```env
# YouTube API Configuration
YOUTUBE_API_KEY=your_youtube_api_key_here

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# Application Configuration
PORT=3001
NODE_ENV=development
```

### 3. Redisé…ç½®é€‰é¡¹

| ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|--------|------|
| `REDIS_HOST` | localhost | RedisæœåŠ¡å™¨åœ°å€ |
| `REDIS_PORT` | 6379 | RedisæœåŠ¡å™¨ç«¯å£ |
| `REDIS_PASSWORD` | (ç©º) | Rediså¯†ç  |
| `REDIS_DB` | 0 | Redisæ•°æ®åº“ç¼–å· |

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. é¢‘é“æ•°æ®ç¼“å­˜
- **ç¼“å­˜é”®æ ¼å¼**ï¼š`yt:channel:{channelId}`
- **TTL**ï¼š24å°æ—¶ï¼ˆ86400ç§’ï¼‰
- **æ•°æ®ç»“æ„**ï¼šJSONåºåˆ—åŒ–çš„ChannelWithEmailså¯¹è±¡

### 2. æ‰¹é‡æ“ä½œä¼˜åŒ–
- æ”¯æŒæ‰¹é‡è·å–é¢‘é“ç¼“å­˜
- å‡å°‘Redisç½‘ç»œå¾€è¿”æ¬¡æ•°
- æé«˜æ‰¹å¤„ç†æ•ˆç‡

### 3. æ™ºèƒ½é™çº§æœºåˆ¶
- Redisè¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨å†…å­˜ç¼“å­˜
- ç¡®ä¿ç³»ç»Ÿä¸ä¼šå› ä¸ºç¼“å­˜é—®é¢˜è€Œåœæ­¢æœåŠ¡
- æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’ŒçŠ¶æ€ç›‘æ§

## ğŸ“Š ç›‘æ§æ¥å£

### 1. ç¼“å­˜å¥åº·æ£€æŸ¥
```http
GET /api/user-details/cache/health
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "ok",
  "message": "Redisè¿æ¥æ­£å¸¸",
  "responseTime": 2,
  "timestamp": "2025-09-12T10:30:00.000Z"
}
```

### 2. APIé…é¢å’Œç¼“å­˜ç»Ÿè®¡
```http
GET /api/user-details/quota
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "message": "APIé…é¢ä½¿ç”¨æƒ…å†µ",
  "rateLimit": {
    "requestsPerMinute": 100,
    "currentMinuteRequests": 15,
    "remainingMinuteRequests": 85
  },
  "cache": {
    "totalCached": 1250,
    "redisConnected": true,
    "memoryFallbackSize": 0,
    "redisMemoryUsage": "2.45 MB"
  }
}
```

### 3. ç¼“å­˜æ¸…ç†
```http
POST /api/user-details/cache/cleanup
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. RedisCacheæœåŠ¡ç±»
- `setChannel()`: è®¾ç½®é¢‘é“ç¼“å­˜
- `getChannel()`: è·å–å•ä¸ªé¢‘é“ç¼“å­˜
- `getChannels()`: æ‰¹é‡è·å–é¢‘é“ç¼“å­˜
- `deleteChannel()`: åˆ é™¤é¢‘é“ç¼“å­˜
- `cleanExpiredCache()`: æ¸…ç†è¿‡æœŸç¼“å­˜
- `healthCheck()`: å¥åº·æ£€æŸ¥

### 2. TaskManageræ”¹è¿›
- æ›¿æ¢å†…å­˜ç¼“å­˜ä¸ºRedisç¼“å­˜
- æ·»åŠ æ‰¹é‡ç¼“å­˜è·å–ä¼˜åŒ–
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
- å¢å¼ºAPIç»Ÿè®¡ä¿¡æ¯

### 3. åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¯åŠ¨æ—¶æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
- ä¼˜é›…å…³é—­æ—¶æ­£ç¡®é‡Šæ”¾Redisè¿æ¥
- å¤„ç†æœªæ•è·å¼‚å¸¸å’ŒPromiseæ‹’ç»

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- **æ™ºèƒ½æ‰¹é‡è·å–**ï¼šå‡å°‘Redisç½‘ç»œè¯·æ±‚
- **ä¼˜å…ˆçº§å¤„ç†**ï¼šæ ¹æ®è§†é¢‘æ´»è·ƒåº¦ä¼˜å…ˆç¼“å­˜
- **TTLç®¡ç†**ï¼š24å°æ—¶è‡ªåŠ¨è¿‡æœŸï¼Œå¹³è¡¡æ€§èƒ½å’Œæ•°æ®æ–°é²œåº¦

### 2. å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- Redisä¸“ä¸šå†…å­˜ç®¡ç†
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸé”®
- é›†åˆç®¡ç†é¢‘é“IDå¼•ç”¨

### 3. ç½‘ç»œä¼˜åŒ–
- è¿æ¥æ± ç®¡ç†
- ç®¡é“æ“ä½œæ”¯æŒ
- é‡è¿æœºåˆ¶

## ğŸ›¡ é”™è¯¯å¤„ç†

### 1. è¿æ¥é”™è¯¯
```typescript
// Redisè¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é™çº§
try {
  const cached = await redisCache.getChannel(channelId);
  return cached;
} catch (error) {
  // ä½¿ç”¨å†…å­˜ç¼“å­˜é™çº§
  return fallbackMemoryCache.get(channelId);
}
```

### 2. è¶…æ—¶å¤„ç†
- è®¾ç½®åˆç†çš„Redisæ“ä½œè¶…æ—¶
- é‡è¯•æœºåˆ¶é¿å…ä¸´æ—¶ç½‘ç»œé—®é¢˜
- æŒ‡æ•°é€€é¿ç­–ç•¥

### 3. æ•°æ®ä¸€è‡´æ€§
- åŸå­æ“ä½œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- äº‹åŠ¡æ”¯æŒå…³é”®æ“ä½œ
- é”™è¯¯å›æ»šæœºåˆ¶

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ç”¨æ³•
```typescript
import { redisCache } from '@/services/RedisCache';

// è®¾ç½®ç¼“å­˜
await redisCache.setChannel('UC123456789', channelData, 3600); // 1å°æ—¶TTL

// è·å–ç¼“å­˜
const cached = await redisCache.getChannel('UC123456789');

// æ‰¹é‡è·å–
const batchResult = await redisCache.getChannels(['UC123', 'UC456', 'UC789']);
```

### 2. å¥åº·æ£€æŸ¥
```typescript
const health = await redisCache.healthCheck();
console.log('RedisçŠ¶æ€:', health.status);
```

## ğŸš¨ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

#### Redisè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping
# åº”è¿”å›: PONG

# æ£€æŸ¥Redisé…ç½®
redis-cli config get "*"
```

#### å†…å­˜ä¸è¶³
```bash
# æ£€æŸ¥Rediså†…å­˜ä½¿ç”¨
redis-cli info memory

# æ¸…ç†è¿‡æœŸé”®
redis-cli --scan --pattern "yt:*" | xargs redis-cli del
```

### 2. æ—¥å¿—ç›‘æ§
- åº”ç”¨å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºRedisè¿æ¥çŠ¶æ€
- ç¼“å­˜æ“ä½œå¤±è´¥ä¼šè®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- è‡ªåŠ¨é™çº§æ—¶ä¼šæœ‰ç›¸åº”æç¤º

### 3. æ€§èƒ½ç›‘æ§
- é€šè¿‡`/api/user-details/quota`æ¥å£ç›‘æ§ç¼“å­˜ä½¿ç”¨æƒ…å†µ
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜é¿å…å†…å­˜æ³„éœ²
- ç›‘æ§APIé…é¢ä½¿ç”¨æƒ…å†µ

## ğŸ”„ è¿ç§»æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**ï¼šç°æœ‰å†…å­˜ç¼“å­˜æ•°æ®åœ¨é‡å¯åä¼šä¸¢å¤±ï¼Œè¿™æ˜¯æ­£å¸¸çš„
2. **é…ç½®æ›´æ–°**ï¼šç¡®ä¿`.env`æ–‡ä»¶åŒ…å«Redisé…ç½®
3. **ä¾èµ–æ£€æŸ¥**ï¼šç¡®ä¿`ioredis`ä¾èµ–å·²å®‰è£…
4. **ç›‘æ§æµ‹è¯•**ï¼šä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£éªŒè¯Redisè¿æ¥

## ğŸ‰ æ€»ç»“

Redisç¼“å­˜æ›¿æ¢å®Œæˆåï¼Œç³»ç»Ÿå°†å…·å¤‡ï¼š
- **æ›´å¥½çš„æ€§èƒ½**ï¼šæŒä¹…åŒ–ç¼“å­˜å‡å°‘APIè°ƒç”¨
- **æ›´é«˜çš„å¯é æ€§**ï¼šåˆ†å¸ƒå¼ç¼“å­˜æ”¯æŒå’Œé™çº§æœºåˆ¶
- **æ›´å¼ºçš„å¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†çš„ç›‘æ§å’Œç»Ÿè®¡ä¿¡æ¯
- **æ›´å¥½çš„æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

ç³»ç»Ÿç°åœ¨å¯ä»¥æ›´æœ‰æ•ˆåœ°ç®¡ç†YouTubeé¢‘é“æ•°æ®ç¼“å­˜ï¼Œå¤§å¹…é™ä½APIé…é¢æ¶ˆè€—ï¼
