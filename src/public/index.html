<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube é¢‘é“æœç´¢å·¥å…·</title>
  <link rel="stylesheet" href="https://unpkg.com/antd@4.24.15/dist/antd.css">
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/antd@4.24.15/dist/antd.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <script type="text/babel">
    // æ£€æŸ¥ antd æ˜¯å¦æ­£ç¡®åŠ è½½
    if (typeof antd === 'undefined') {
      console.error('Antd æœªæ­£ç¡®åŠ è½½!');
      document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">Antd åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
    } else {
      console.log('Antd åŠ è½½æˆåŠŸ:', Object.keys(antd));
    }
    
    const { useState, useEffect } = React;
    const { Input, Select, Button, Card, Spin, Tag, Space, Row, Col, Typography, Badge, message, Table } = antd;
    const { Title, Paragraph, Text } = Typography;
    
    function App() {
      const [searchQuery, setSearchQuery] = useState('');
      const [searchType, setSearchType] = useState('1');
      const [searchRange, setSearchRange] = useState('50');
      const [loading, setLoading] = useState(false);
      const [results, setResults] = useState(null);
      const [tableData, setTableData] = useState([]);
      
      const handleSearch = async () => {
        if (!searchQuery.trim()) {
          message.warning('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
          return;
        }
        
        setLoading(true);
        try {
          const response = await axios.get('/api/search/video', {
            params: {
              q: searchQuery,
              type: searchType,
              range: searchRange
            }
          });
          setResults(response.data);
          
          // å¤„ç†æ•°æ®ä»¥é€‚é…è¡¨æ ¼
          const processedData = response.data.results?.map((channel, index) => ({
            key: index,
            title: channel.title || 'æœªçŸ¥',
            emails: channel.email || [],
            emailsText: (channel.email || []).join(', '),
            subscriberCount: channel.subscriberCount || '0',
            viewCount: channel.viewCount || '0',
            videoCount: channel.videoCount || '0',
            customUrl: channel.customUrl || '',
            description: channel.description || '',
            keywords: channel.keywords || ''
          })) || [];
          
          setTableData(processedData);
          message.success(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${response.data.results?.length || 0} ä¸ªé¢‘é“`);
        } catch (error) {
          console.error('æœç´¢å¤±è´¥:', error);
          message.error('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        } finally {
          setLoading(false);
        }
      };
      
      const formatNumber = (num) => {
        if (!num) return '0';
        const number = parseInt(num);
        if (number >= 1000000) {
          return (number / 1000000).toFixed(1) + 'M';
        }
        if (number >= 1000) {
          return (number / 1000).toFixed(1) + 'K';
        }
        return number.toString();
      };
      
      // Excelå¯¼å‡ºåŠŸèƒ½
      const exportToExcel = () => {
        if (!tableData.length) {
          message.warning('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');
          return;
        }
        
        // å‡†å¤‡å¯¼å‡ºæ•°æ®
        const exportData = tableData.map((row, index) => ({
          'åºå·': index + 1,
          'é¢‘é“åç§°': row.title,
          'è”ç³»é‚®ç®±': row.emailsText,
          'è®¢é˜…æ•°': row.subscriberCount,
          'æ€»è§‚çœ‹æ•°': row.viewCount,
          'è§†é¢‘æ•°': row.videoCount,
          'è‡ªå®šä¹‰URL': row.customUrl,
          'å…³é”®è¯': row.keywords,
          'æè¿°': row.description 
        }));
        
        // åˆ›å»ºå·¥ä½œç°¿
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'é¢‘é“ä¿¡æ¯');
        
        // è®¾ç½®åˆ—å®½
        const colWidths = [
          { wch: 6 },   // åºå·
          { wch: 30 },  // é¢‘é“åç§°
          { wch: 40 },  // è”ç³»é‚®ç®±
          { wch: 12 },  // è®¢é˜…æ•°
          { wch: 15 },  // æ€»è§‚çœ‹æ•°
          { wch: 10 },  // è§†é¢‘æ•°
          { wch: 25 },  // è‡ªå®šä¹‰URL
          { wch: 20 },  // å…³é”®è¯
          { wch: 80 }   // æè¿°
        ];
        ws['!cols'] = colWidths;
        
        // ä¸‹è½½æ–‡ä»¶
        const fileName = `YouTubeé¢‘é“ä¿¡æ¯_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        message.success(`æˆåŠŸå¯¼å‡º ${tableData.length} æ¡è®°å½•åˆ° ${fileName}`);
      };
      
      // å®šä¹‰è¡¨æ ¼åˆ—
      const columns = [
        {
          title: 'åºå·',
          key: 'index',
          width: 60,
          render: (text, record, index) => index + 1,
          align: 'center'
        },
        {
          title: 'é¢‘é“åç§°',
          dataIndex: 'title',
          key: 'title',
          width: 250,
          ellipsis: true,
          render: (text) => (
            <Text strong style={{ fontSize: '16px' }}>{text}</Text>
          )
        },
        {
          title: 'è”ç³»é‚®ç®±',
          dataIndex: 'emails',
          key: 'emails',
          width: 300,
          render: (emails) => (
            <Space direction="vertical" size="small">
              {emails.length > 0 ? (
                emails.map((email, idx) => (
                  <Tag key={idx} color="success" style={{ margin: '2px 4px 2px 0' }}>
                    ğŸ“§ {email}
                  </Tag>
                ))
              ) : (
                <Text type="secondary">æ— é‚®ç®±ä¿¡æ¯</Text>
              )}
            </Space>
          )
        },
        {
          title: 'è®¢é˜…æ•°',
          dataIndex: 'subscriberCount',
          key: 'subscriberCount',
          width: 100,
          align: 'right',
          sorter: (a, b) => parseInt(a.subscriberCount) - parseInt(b.subscriberCount),
          render: (count) => (
            <Text strong>ğŸ‘¥ {formatNumber(count)}</Text>
          )
        },
        {
          title: 'æ€»è§‚çœ‹æ•°',
          dataIndex: 'viewCount',
          key: 'viewCount',
          width: 120,
          align: 'right',
          sorter: (a, b) => parseInt(a.viewCount) - parseInt(b.viewCount),
          render: (count) => (
            <Text strong>ğŸ‘€ {formatNumber(count)}</Text>
          )
        },
        {
          title: 'è§†é¢‘æ•°',
          dataIndex: 'videoCount',
          key: 'videoCount',
          width: 80,
          align: 'right',
          sorter: (a, b) => parseInt(a.videoCount) - parseInt(b.videoCount),
          render: (count) => (
            <Text strong>ğŸ¬ {formatNumber(count)}</Text>
          )
        },
        {
          title: 'è‡ªå®šä¹‰URL',
          dataIndex: 'customUrl',
          key: 'customUrl',
          width: 180,
          ellipsis: true,
          render: (url) => url ? (
            <Text code>{url}</Text>
          ) : (
            <Text type="secondary">æ— </Text>
          )
        },
        {
          title: 'é¢‘é“æè¿°',
          dataIndex: 'description',
          key: 'description',
          render: (description) => (
            <div style={{ width: 200 }}>
              <Paragraph
              ellipsis={{ rows: 2, expandable: true, symbol: 'æ›´å¤š' }}
              style={{ marginBottom: 0, fontSize: '12px'}}
            >
              {description || 'æ— æè¿°ä¿¡æ¯'}
            </Paragraph>
            </div>
          )
        }
      ];
      
      return (
        <div className="container">
          <div className="header">
            <Title level={1} style={{ color: 'white', textAlign: 'center', marginBottom: 8 }}>
              ğŸ¥ YouTube é¢‘é“æœç´¢å·¥å…·
            </Title>
            <Paragraph style={{ color: 'white', textAlign: 'center', opacity: 0.9, fontSize: '18px' }}>
              æœç´¢ YouTube é¢‘é“å¹¶è·å–è”ç³»é‚®ç®±ä¿¡æ¯
            </Paragraph>
          </div>
          
          <Card className="search-card" style={{ marginBottom: 24 }}>
            <Space direction="vertical" size="large" style={{ width: '100%' }}>
              <Row gutter={16} align="bottom">
                <Col xs={24} sm={12} md={8}>
                  <div>
                    <Text strong style={{ marginBottom: 8, display: 'block' }}>æœç´¢å…³é”®è¯</Text>
                    <Input
                      allowClear
                      size="large"
                      placeholder="è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼Œå¦‚ï¼šç¾é£Ÿåšä¸»ã€ç§‘æŠ€è¯„æµ‹..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      onPressEnter={handleSearch}
                      prefix={<span>ğŸ”</span>}
                    />
                  </div>
                </Col>
                
                <Col xs={24} sm={8} md={6}>
                  <div>
                    <Text strong style={{ marginBottom: 8, display: 'block' }}>æœç´¢ç±»å‹</Text>
                    <Select
                      size="large"
                      value={searchType}
                      onChange={setSearchType}
                      style={{ width: '100%' }}
                    >
                      <Select.Option value="1">ä»…æœ‰é‚®ç®±çš„é¢‘é“</Select.Option>
                      <Select.Option value="2">æ‰€æœ‰é¢‘é“è¯¦æƒ…</Select.Option>
                    </Select>
                  </div>
                </Col>

                <Col xs={24} sm={8} md={6}>
                  <div>
                    <Text strong style={{ marginBottom: 8, display: 'block' }}>æœç´¢èŒƒå›´</Text>
                    <Select
                      size="large"
                      value={searchRange}
                      onChange={setSearchRange}
                      style={{ width: '100%' }}
                    >
                      <Select.Option value="50">50æ¡</Select.Option>
                      <Select.Option value="100">100æ¡</Select.Option>
                      <Select.Option value="200">200æ¡</Select.Option>
                      <Select.Option value="500">500æ¡</Select.Option>
                    </Select>
                  </div>
                </Col>
                
                <Col xs={24} sm={4} md={4}>
                  <Button
                    type="primary"
                    size="large"
                    onClick={handleSearch}
                    loading={loading}
                    block
                    className="gradient-btn"
                    style={{ height: '40px' }}
                  >
                    {loading ? 'æœç´¢ä¸­...' : 'ğŸ” æœç´¢'}
                  </Button>
                </Col>
              </Row>
            </Space>
          </Card>
          
          {loading && (
            <Card style={{ textAlign: 'center', marginBottom: 24 }}>
              <Spin size="large" />
              <div style={{ marginTop: 16 }}>
                <Text>ğŸ” æ­£åœ¨æœç´¢ä¸­ï¼Œè¯·ç¨å€™...</Text>
              </div>
            </Card>
          )}
          
          {results && !loading && (
            <Card 
              title={
                <Space>
                  <Text strong style={{ fontSize: '18px' }}>
                    æœç´¢ç»“æœ: {tableData.length} ä¸ªé¢‘é“
                  </Text>
                  {results.count > 0 && (
                    <Badge 
                      count={`${results.count} ä¸ªæœ‰é‚®ç®±`} 
                      style={{ 
                        backgroundColor: '#52c41a',
                        fontSize: '12px'
                      }} 
                    />
                  )}
                </Space>
              }
              extra={
                <Button
                  type="primary"
                  icon="ğŸ“Š"
                  onClick={exportToExcel}
                  disabled={!tableData.length}
                  className="gradient-btn"
                >
                  å¯¼å‡ºExcel
                </Button>
              }
            >
              {tableData.length > 0 ? (
                <Table
                  columns={columns}
                  dataSource={tableData}
                  scroll={{ x: 'max-content', y: 600 }}
                  pagination={{
                    showSizeChanger: true,
                    showQuickJumper: true,
                    showTotal: (total, range) => 
                      `ç¬¬ ${range[0]}-${range[1]} æ¡ï¼Œå…± ${total} æ¡`,
                    pageSizeOptions: ['10', '20', '50', '100'],
                    defaultPageSize: 10
                  }}
                  size="middle"
                  bordered
                  style={{ marginTop: 16 }}
                />
              ) : (
                <div style={{ textAlign: 'center', padding: '60px 20px' }}>
                  <Text type="secondary" style={{ fontSize: '16px' }}>
                    ğŸ˜… æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é¢‘é“ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯
                  </Text>
                </div>
              )}
            </Card>
          )}
        </div>
      );
    }
    
    const container = document.getElementById('root');
    if (ReactDOM.createRoot) {
      // React 18
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    } else {
      // React 17 åŠä»¥ä¸‹
      ReactDOM.render(<App />, container);
    }
  </script>
</body>
</html>